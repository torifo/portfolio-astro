---
// ThemeToggle.astro - ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆã¨æ™‚é–“è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
---

<div class="theme-menu flex items-center space-x-4">
  <!-- ç¾åœ¨æ™‚åˆ»è¡¨ç¤º -->
  <div class="current-time text-cyan-400 font-mono text-sm"></div>
  
  <!-- æ—¥ã®å‡ºãƒ»æ—¥æ²¡æ™‚é–“è¡¨ç¤º -->
  <div class="sun-times text-xs text-gray-400 space-y-1">
    <div id="sunriseTime">Sunrise: --:--</div>
    <div id="sunsetTime">Sunset: --:--</div>
  </div>
  
  <!-- ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
  <div class="relative">
    <button id="themeToggleBtn" class="p-2 rounded-lg glass hover:bg-white/10 transition-all duration-300" title="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
      <!-- å¤ªé™½ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ -->
      <svg id="sunIcon" class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
      </svg>
      <!-- æœˆã‚¢ã‚¤ã‚³ãƒ³ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ -->
      <svg id="moonIcon" class="w-5 h-5 text-blue-300 hidden" fill="currentColor" viewBox="0 0 20 20">
        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
      </svg>
    </button>
    
    <!-- ãƒ†ãƒ¼ãƒãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="theme-dropdown absolute right-0 top-full mt-2 w-48 glass rounded-lg shadow-lg hidden z-50">
      <button data-theme="light" class="w-full px-4 py-2 text-left text-gray-300 hover:text-cyan-400 hover:bg-white/10 rounded-t-lg transition-colors">
        â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰
      </button>
      <button data-theme="dark" class="w-full px-4 py-2 text-left text-gray-300 hover:text-cyan-400 hover:bg-white/10 transition-colors">
        ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
      </button>
      <button data-theme="auto" class="w-full px-4 py-2 text-left text-gray-300 hover:text-cyan-400 hover:bg-white/10 rounded-b-lg transition-colors">
        ğŸŒ… è‡ªå‹•ï¼ˆæ—¥æ²¡ã«åˆã‚ã›ã‚‹ï¼‰
      </button>
    </div>
  </div>
</div>

<script>
  // æ—¥ã®å‡ºãƒ»æ—¥æ²¡APIè¨­å®š
  const LATITUDE = 35.6762; // æ±äº¬ã®ç·¯åº¦
  const LONGITUDE = 139.6503; // æ±äº¬ã®çµŒåº¦
  
  // æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
  function formatTime(date: Date): string {
    return date.toLocaleTimeString('ja-JP', {
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'Asia/Tokyo'
    });
  }
  
  // ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateCurrentTime(): void {
    const now = new Date();
    const timeElement = document.querySelector('.current-time');
    if (timeElement) {
      timeElement.textContent = now.toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'Asia/Tokyo'
      });
    }
  }
  
  // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ&æ—¥ã®å‡ºæ—¥æ²¡æ™‚é–“è¡¨ç¤ºé–¢æ•°
  async function setThemeBasedOnSunriseSunset(): Promise<void> {
    try {
      const response = await fetch(`https://api.sunrise-sunset.org/json?lat=${LATITUDE}&lng=${LONGITUDE}&formatted=0`);
      
      if (!response.ok) {
        throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.status !== 'OK') {
        throw new Error('APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }
      
      // æ—¥ã®å‡ºãƒ»æ—¥æ²¡æ™‚é–“ã‚’å–å¾— (UTC)
      const sunriseUTC = new Date(data.results.sunrise);
      const sunsetUTC = new Date(data.results.sunset);
      
      // ç¾åœ¨æ™‚åˆ»ï¼ˆUTCï¼‰ã§çµ±ä¸€ã—ã¦æ¯”è¼ƒ
      const nowUTC = new Date();
      
      // formatTimeé–¢æ•°ã¯æ—¢ã«JSTã«å¤‰æ›ã—ã¦ãã‚Œã‚‹ã®ã§ã€ãã®ã¾ã¾ä½¿ç”¨
      const sunriseTime = formatTime(sunriseUTC);
      const sunsetTime = formatTime(sunsetUTC);
      
      // æ—¥ã®å‡ºãƒ»æ—¥æ²¡æ™‚é–“ã‚’è¡¨ç¤ºï¼ˆæ­£ã—ã„é †åºã§ï¼‰
      const sunriseElement = document.getElementById('sunriseTime');
      const sunsetElement = document.getElementById('sunsetTime');
      
      if (sunriseElement) sunriseElement.textContent = `Sunrise: ${sunriseTime}`;
      if (sunsetElement) sunsetElement.textContent = `Sunset: ${sunsetTime}`;
      
      // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆUTCã§çµ±ä¸€ã—ã¦æ¯”è¼ƒï¼‰
      // æ—¥ã®å‡ºå¾Œã‹ã‚‰æ—¥æ²¡å‰ã®å ´åˆï¼šãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰
      // æ—¥æ²¡å¾Œã¾ãŸã¯æ—¥ã®å‡ºå‰ã®å ´åˆï¼šãƒŠã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰
      if (nowUTC >= sunriseUTC && nowUTC <= sunsetUTC) {
        document.body.classList.add('light-mode');
        document.body.classList.remove('night-mode');
        console.log('ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ:', {
          now: nowUTC.toISOString(),
          sunrise: sunriseUTC.toISOString(),
          sunset: sunsetUTC.toISOString()
        });
      } else {
        document.body.classList.add('night-mode');
        document.body.classList.remove('light-mode');
        console.log('ãƒŠã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ:', {
          now: nowUTC.toISOString(),
          sunrise: sunriseUTC.toISOString(),
          sunset: sunsetUTC.toISOString()
        });
      }
      
      // ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
      updateThemeIcon();
      
    } catch (error) {
      console.error('æ—¥ã®å‡ºãƒ»æ—¥æ²¡æ™‚é–“ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œ
      const defaultSunsetHour = 18;
      const now = new Date().getHours();
      
      document.body.classList.toggle('night-mode', now >= defaultSunsetHour);
      document.body.classList.toggle('light-mode', now < defaultSunsetHour);
      
      // ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
      updateThemeIcon();
      
      const sunriseElement = document.getElementById('sunriseTime');
      const sunsetElement = document.getElementById('sunsetTime');
      
      if (sunriseElement) sunriseElement.textContent = 'Sunrise: æœªå–å¾—';
      if (sunsetElement) sunsetElement.textContent = 'Sunset: æœªå–å¾—';
    }
  }
  
  // ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateThemeIcon(): void {
    const sunIcon = document.getElementById('sunIcon');
    const moonIcon = document.getElementById('moonIcon');
    
    if (sunIcon && moonIcon) {
      if (document.body.classList.contains('night-mode')) {
        sunIcon.classList.add('hidden');
        moonIcon.classList.remove('hidden');
      } else {
        sunIcon.classList.remove('hidden');
        moonIcon.classList.add('hidden');
      }
    }
  }
  
  // ãƒ†ãƒ¼ãƒãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ¶å¾¡
  const themeToggleBtn = document.getElementById('themeToggleBtn');
  const themeDropdown = document.querySelector('.theme-dropdown');
  
  if (themeToggleBtn && themeDropdown) {
    themeToggleBtn.addEventListener('click', () => {
      themeDropdown.classList.toggle('hidden');
    });
    
    // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', (e) => {
      if (!themeToggleBtn.contains(e.target as Node) && !themeDropdown.contains(e.target as Node)) {
        themeDropdown.classList.add('hidden');
      }
    });
  }
  
  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ãƒ†ãƒ¼ãƒé¸æŠ
  document.querySelectorAll('.theme-dropdown button').forEach(button => {
    button.addEventListener('click', (event) => {
      const selectedTheme = (event.currentTarget as HTMLButtonElement).getAttribute('data-theme');
      
      if (selectedTheme === 'light') {
        document.body.classList.remove('night-mode');
        document.body.classList.add('light-mode');
        updateThemeIcon();
      } else if (selectedTheme === 'dark') {
        document.body.classList.remove('light-mode');
        document.body.classList.add('night-mode');
        updateThemeIcon();
      } else if (selectedTheme === 'auto') {
        setThemeBasedOnSunriseSunset();
      }
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      if (themeDropdown) {
        themeDropdown.classList.add('hidden');
      }
    });
  });
  
  // åˆå›èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
  window.addEventListener('load', () => {
    // ç¾åœ¨æ™‚åˆ»ã®å®šæœŸçš„ãªæ›´æ–°
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    // ãƒ†ãƒ¼ãƒè¨­å®š
    setThemeBasedOnSunriseSunset();
    
    // åˆå›ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
    setTimeout(updateThemeIcon, 100);
  });
  
  // å®šæœŸçš„ã«ãƒ†ãƒ¼ãƒã‚’ç¢ºèªãƒ»å¤‰æ›´ï¼ˆ30åˆ†ã”ã¨ï¼‰
  setInterval(setThemeBasedOnSunriseSunset, 30 * 60 * 1000);
</script>